<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QualiÁgua - Análise de Qualidade da Água</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
        }

        body {
            padding-top: 56px; /* Add padding for fixed navbar */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .sidebar {
            background-color: #ffffff;
            border-right: 1px solid #dee2e6;
            height: 100vh;
            position: fixed;
            overflow-y: scroll; /* Changed from auto to scroll to force scrollbar */
            z-index: 100;
            width: 250px;
            padding: 20px 10px;
            top: 56px; /* Account for navbar height */
            bottom: 0;
            max-height: calc(100vh - 56px); /* Ensure it doesn't overflow */
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }

        .card-header {
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0 !important;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        .nav-link {
            border-radius: 5px;
            margin-bottom: 5px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            padding: 10px 15px;
        }

        .nav-link i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        .nav-link:hover:not(.active) {
            background-color: #77cef4;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 1rem;
            color: var(--secondary-color);
        }

        .conformidade-alta {
            color: var(--success-color);
        }

        .conformidade-media {
            color: var(--warning-color);
        }

        .conformidade-baixa {
            color: var(--danger-color);
        }

        .table th {
            font-weight: 600;
            background-color: #f8f9fa;
        }

        .filter-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .btn-filter {
            margin-top: 10px;
        }

        .tab-content {
            padding-top: 20px;
        }

        .plotly-graph {
            width: 100%;
            height: 600px; /* Aumentado ainda mais para dar mais espaço vertical */
            margin-bottom: 50px; /* Aumentado para dar mais espaço entre os gráficos */
            min-height: 600px; /* Garantir altura mínima */
        }

        .map-container {
            width: 100%;
            height: 600px;
            border-radius: 10px;
            overflow: hidden;
        }

        .navbar-brand {
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .navbar-brand i {
            margin-right: 10px;
            font-size: 1.5rem;
        }

        .section-title {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Ajustes para responsividade */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                margin-bottom: 20px;
                max-height: none;
                overflow-y: visible;
            }

            .main-content {
                margin-left: 0;
            }

            .stat-value {
                font-size: 2rem;
            }
        }

        /* Estilo para o botão de atualização */
        .btn-update {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .btn-update i {
            font-size: 1.5rem;
        }

        /* Estilo para o footer */
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        /* Ajustes específicos para os gráficos de bairros e ponto de coleta */
        #bairrosAnalises, #bairrosConformidade, #pontoColetaChart {
            height: 900px !important; /* Aumentado ainda mais para dar mais espaço */
            margin-bottom: 80px !important; /* Maior espaço entre os gráficos */
            min-height: 900px; /* Garantir altura mínima */
            overflow: visible !important; /* Garantir que o conteúdo não seja cortado */
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-droplet-fill"></i>
                QualiÁgua
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">
                            <i class="bi bi-info-circle"></i> Sobre
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block sidebar" id="dashboard-sidebar">
                <h5 class="mt-3 mb-4">Navegação</h5>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#visaoGeral" data-bs-toggle="tab">
                            <i class="bi bi-eye"></i> Visão Geral
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#rankingBairro" data-bs-toggle="tab">
                            <i class="bi bi-bar-chart"></i> Ranking por Bairro
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#conformidade" data-bs-toggle="tab">
                            <i class="bi bi-check-circle"></i> Conformidade
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#distribuicao" data-bs-toggle="tab">
                            <i class="bi bi-pie-chart"></i> Distribuição
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#tendencias" data-bs-toggle="tab">
                            <i class="bi bi-graph-up"></i> Tendências
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#mapa" data-bs-toggle="tab">
                            <i class="bi bi-geo-alt"></i> Mapa
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <div class="tab-content">
                    <!-- Visão Geral -->
                    <div class="tab-pane fade show active" id="visaoGeral">
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <span>Filtros</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="filtroAno" class="filter-label">Ano</label>
                                                    <select class="form-select" id="filtroAno">
                                                        <option value="todos">Todos</option>
                                                        <option value="2025">2025</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="filtroMes" class="filter-label">Mês</label>
                                                    <select class="form-select" id="filtroMes">
                                                        <option value="todos">Todos</option>
                                                        <option value="1">Janeiro</option>
                                                        <option value="2">Fevereiro</option>
                                                        <option value="3">Março</option>
                                                        <option value="4">Abril</option>
                                                        <option value="5">Maio</option>
                                                        <option value="6">Junho</option>
                                                        <option value="7">Julho</option>
                                                        <option value="8">Agosto</option>
                                                        <option value="9">Setembro</option>
                                                        <option value="10">Outubro</option>
                                                        <option value="11">Novembro</option>
                                                        <option value="12">Dezembro</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="d-flex justify-content-end">
                                                    <button class="btn btn-outline-secondary me-2" id="btnLimparFiltros">
                                                        <i class="bi bi-x-circle"></i> Limpar Filtros
                                                    </button>
                                                    <button class="btn btn-primary" id="btnAplicarFiltros">
                                                        <i class="bi bi-funnel"></i> Aplicar Filtros
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h2 class="section-title">Visão Geral da Qualidade da Água</h2>

                        <!-- Estatísticas Gerais -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card stat-card">
                                    <div class="stat-value text-primary">{{ stats.total_amostras }}</div>
                                    <div class="stat-label">Total de Amostras</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stat-card">
                                    <div class="stat-value conformidade-alta">{{ "%.1f"|format(stats.conformidade_geral) }}%</div>
                                    <div class="stat-label">Amostras Conformes</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stat-card">
                                    <div class="stat-value conformidade-baixa">{{ "%.1f"|format(stats.nao_conformidade_geral) }}%</div>
                                    <div class="stat-label">Amostras Não Conformes</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stat-card">
                                    <div class="stat-value text-info">{{ stats.bairros_unicos }}</div>
                                    <div class="stat-label">Bairros Analisados</div>
                                </div>
                            </div>
                        </div>

                        <!-- Gráfico de Distribuição Geral -->
                        <div class="card">
                            <div class="card-header">
                                <span>Distribuição Geral de Amostras</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnDistribuicaoGeral">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="distribuicaoGeral" class="plotly-graph"></div>
                            </div>
                        </div>

                        <!-- Gráfico de Conformidade por Parâmetro -->
                        <div class="card">
                            <div class="card-header">
                                <span>Conformidade por Parâmetro</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnConformidadeParametro">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="conformidadeParametro" class="plotly-graph"></div>
                            </div>
                        </div>

                        <!-- Tabela de Resumo dos Parâmetros -->
                        <div class="card">
                            <div class="card-header">Resumo dos Parâmetros</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Parâmetro</th>
                                                <th>Valor de Referência</th>
                                                <th>Conformidade</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Escherichia coli</td>
                                                <td>Ausência em 100mL</td>
                                                <td>{{ "%.1f"|format(stats.conformidade_ecoli) }}%</td>
                                                <td>
                                                    {% if stats.conformidade_ecoli >= 90 %}
                                                    <span class="badge bg-success">Excelente</span>
                                                    {% elif stats.conformidade_ecoli >= 70 %}
                                                    <span class="badge bg-warning text-dark">Atenção</span>
                                                    {% else %}
                                                    <span class="badge bg-danger">Crítico</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Coliformes totais</td>
                                                <td>Ausência em 100mL</td>
                                                <td>{{ "%.1f"|format(stats.conformidade_coliformes) }}%</td>
                                                <td>
                                                    {% if stats.conformidade_coliformes >= 90 %}
                                                    <span class="badge bg-success">Excelente</span>
                                                    {% elif stats.conformidade_coliformes >= 70 %}
                                                    <span class="badge bg-warning text-dark">Atenção</span>
                                                    {% else %}
                                                    <span class="badge bg-danger">Crítico</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Turbidez</td>
                                                <td>Máximo de 5,0 uT</td>
                                                <td>{{ "%.1f"|format(stats.conformidade_turbidez) }}%</td>
                                                <td>
                                                    {% if stats.conformidade_turbidez >= 90 %}
                                                    <span class="badge bg-success">Excelente</span>
                                                    {% elif stats.conformidade_turbidez >= 70 %}
                                                    <span class="badge bg-warning text-dark">Atenção</span>
                                                    {% else %}
                                                    <span class="badge bg-danger">Crítico</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Cloro residual livre</td>
                                                <td>0,2 a 5,0 mg/L</td>
                                                <td>{{ "%.1f"|format(stats.conformidade_cloro) }}%</td>
                                                <td>
                                                    {% if stats.conformidade_cloro >= 90 %}
                                                    <span class="badge bg-success">Excelente</span>
                                                    {% elif stats.conformidade_cloro >= 70 %}
                                                    <span class="badge bg-warning text-dark">Atenção</span>
                                                    {% else %}
                                                    <span class="badge bg-danger">Crítico</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ranking por Bairro -->
                    <div class="tab-pane fade" id="rankingBairro">
                        <h2 class="section-title">Ranking de Análises por Bairro</h2>

                        <!-- Top 20 Bairros com Mais Análises -->
                        <div class="card">
                            <div class="card-header">
                                <span>Top 20 Bairros com Mais Análises</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnBairrosAnalises">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="bairrosAnalises" class="plotly-graph"></div>
                            </div>
                        </div>

                        <!-- Top 20 Bairros com Menor Conformidade -->
                        <div class="card">
                            <div class="card-header">
                                <span>Top 20 Bairros com Menor Conformidade com Mais de 5 Coletas</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnBairrosConformidade">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="bairrosConformidade" class="plotly-graph"></div>
                            </div>
                        </div>

                        <!-- Tabela de Bairros -->
                        <div class="card">
                            <div class="card-header">Tabela de Bairros</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped" id="tabelaBairros">
                                        <thead>
                                            <tr>
                                                <th>Bairro</th>
                                                <th>Total de Análises</th>
                                                <th>% Conformidade</th>
                                                <th>E. coli</th>
                                                <th>Coliformes</th>
                                                <th>Turbidez</th>
                                                <th>Cloro</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Preenchido via JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Conformidade -->
                    <div class="tab-pane fade" id="conformidade">
                        <h2 class="section-title">Conformidade com a Portaria GM/MS Nº 888/2021</h2>

                        <!-- Conformidade por Parâmetro -->
                        <div class="card">
                            <div class="card-header">
                                <span>Conformidade por Parâmetro</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnConformidadeParametroTab">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="conformidadeParametroTab" class="plotly-graph"></div>
                            </div>
                        </div>

                        <!-- Conformidade por Ponto de Coleta -->
                        <div class="card">
                            <div class="card-header">
                                <span>Conformidade por Ponto de Coleta</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnPontoColeta">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="pontoColetaChart" class="plotly-graph"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Distribuição -->
                    <div class="tab-pane fade" id="distribuicao">
                        <h2 class="section-title">Distribuição dos Resultados</h2>

                        <!-- Distribuição por Mês -->
                        <div class="card">
                            <div class="card-header">
                                <span>Distribuição por Mês</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnDistribuicaoMes">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="distribuicaoMes" class="plotly-graph"></div>
                            </div>
                        </div>

                        <!-- Distribuição por Parâmetro -->
                        <div class="card">
                            <div class="card-header">
                                <span>Distribuição por Parâmetro</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnDistribuicaoParametro">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="distribuicaoParametro" class="plotly-graph"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Tendências -->
                    <div class="tab-pane fade" id="tendencias">
                        <h2 class="section-title">Tendências ao Longo do Ano</h2>

                        <!-- Tendência de Conformidade -->
                        <div class="card">
                            <div class="card-header">
                                <span>Tendência de Conformidade</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnTendenciaConformidade">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="tendenciaConformidade" class="plotly-graph"></div>
                            </div>
                        </div>

                        <!-- Tendência por Parâmetro -->
                        <div class="card">
                            <div class="card-header">
                                <span>Tendência por Parâmetro</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnTendenciaParametro">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="tendenciaParametro" class="plotly-graph"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Mapa -->
                    <div class="tab-pane fade" id="mapa">
                        <h2 class="section-title">Visualização Geográfica</h2>

                        <!-- Mapa de Coletas -->
                        <div class="card">
                            <div class="card-header">
                                <span>Mapa de Coletas</span>
                                <button class="btn btn-sm btn-outline-primary" id="btnMapaColetas">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="map-container">
                                    <iframe src="/static/mapa_coletas.html" width="100%" height="100%" frameborder="0"></iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="footer">
                    <p>Dashboard Sisagua - Análise de Qualidade da Água - 2025</p>
                    <p>Dados coletados da API do Sisagua - Última atualização: {{ ultima_atualizacao }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Sobre -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sobre o Dashboard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Este dashboard apresenta análises dos dados do Sisagua (Sistema de Informação de Vigilância da Qualidade da Água para Consumo Humano) para o ano de 2025.</p>
                    <p>As análises incluem:</p>
                    <ul>
                        <li>Ranking de análises por bairro</li>
                        <li>Verificação de conformidade com a Portaria GM/MS Nº 888/2021</li>
                        <li>Distribuição dos resultados por mês, ponto de coleta e tipo de abastecimento</li>
                        <li>Tendências ao longo do ano</li>
                        <li>Visualização geográfica das coletas</li>
                    </ul>
                    <p>Os parâmetros analisados são:</p>
                    <ul>
                        <li>Escherichia coli</li>
                        <li>Coliformes totais</li>
                        <li>Turbidez</li>
                        <li>Cloro residual livre</li>
                    </ul>
                    <p>Desenvolvedores</p>
                    <ul>
                        <li>Bianca Santos</li>
                        <li>Fernando Melo</li>
                        <li>Igor Natan</li>
                        <li>Raquel Moura</li>
                        <li>Vinicius dos Santos</li>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botão de Atualização -->
    <button class="btn btn-update" id="btnAtualizar" title="Atualizar Dados">
        <i class="bi bi-arrow-clockwise"></i>
    </button>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    
    <script>
        // Dados iniciais
        let bairrosData = [];
        let mesesData = [];
        let pontosColetaData = [];
        
        // Função para carregar dados dos bairros
        function carregarDadosBairros() {
            $.ajax({
                url: '/api/bairros',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    bairrosData = data;
                    preencherTabelaBairros(data);
                    criarGraficoBairrosAnalises(data);
                    criarGraficoBairrosConformidade(data);
                },
                error: function(error) {
                    console.error('Erro ao carregar dados dos bairros:', error);
                }
            });
        }
        
        // Função para carregar distribuição por mês
        function carregarDistribuicaoMes() {
            $.ajax({
                url: '/api/distribuicao_mes',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    mesesData = data;
                    criarGraficoDistribuicaoMes(data);
                    criarGraficoTendenciaConformidade(data);
                    criarGraficoTendenciaParametro(data);
                },
                error: function(error) {
                    console.error('Erro ao carregar distribuição por mês:', error);
                }
            });
        }
        
        // Função para carregar distribuição por ponto de coleta
        function carregarDistribuicaoPontoColeta() {
            $.ajax({
                url: '/api/distribuicao_ponto_coleta',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    pontosColetaData = data;
                    criarGraficoPontoColeta(data);
                },
                error: function(error) {
                    console.error('Erro ao carregar distribuição por ponto de coleta:', error);
                }
            });
        }
        
        // Função para preencher a tabela de bairros
        function preencherTabelaBairros(data) {
            const tabela = $('#tabelaBairros tbody');
            tabela.empty();
            
            data.forEach(function(bairro) {
                const row = $('<tr></tr>');
                row.append(`<td>${bairro.bairro}</td>`);
                row.append(`<td>${bairro.total_analises}</td>`);
                row.append(`<td>${bairro.percentual_conforme.toFixed(1)}%</td>`);
                
                // Adicionar percentuais por parâmetro
                const ecoli = bairro.percentual_ecoli !== null ? `${bairro.percentual_ecoli.toFixed(1)}%` : 'N/A';
                const coliformes = bairro.percentual_coliformes !== null ? `${bairro.percentual_coliformes.toFixed(1)}%` : 'N/A';
                const turbidez = bairro.percentual_turbidez !== null ? `${bairro.percentual_turbidez.toFixed(1)}%` : 'N/A';
                const cloro = bairro.percentual_cloro !== null ? `${bairro.percentual_cloro.toFixed(1)}%` : 'N/A';
                
                row.append(`<td>${ecoli}</td>`);
                row.append(`<td>${coliformes}</td>`);
                row.append(`<td>${turbidez}</td>`);
                row.append(`<td>${cloro}</td>`);
                
                tabela.append(row);
            });
        }
        
        // Função para criar gráfico de distribuição geral
        function criarGraficoDistribuicaoGeral(conformidade, naoConformidade) {
            const data = [{
                values: [conformidade, naoConformidade],
                labels: ['Conforme', 'Não Conforme'],
                type: 'pie',
                marker: {
                    colors: ['#198754', '#dc3545']
                },
                textinfo: 'label+percent',
                textposition: 'inside',
                insidetextfont: {
                    color: 'white',
                    size: 14
                },
                hoverinfo: 'label+percent+value',
                hole: 0.4
            }];
            
            const layout = {
                title: 'Distribuição Geral de Amostras',
                height: 400,
                margin: {l: 50, r: 50, b: 50, t: 50, pad: 4},
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.1
                }
            };
            
            Plotly.newPlot('distribuicaoGeral', data, layout, {responsive: true});
        }
        
        // Função para criar gráfico de conformidade por parâmetro
        function criarGraficoConformidadeParametro(ecoli, coliformes, turbidez, cloro) {
            const data = [{
                x: ['E. coli', 'Coliformes', 'Turbidez', 'Cloro'],
                y: [ecoli, coliformes, turbidez, cloro],
                type: 'bar',
                marker: {
                    color: '#198754'
                },
                hovertemplate: '%{y:.1f}%<extra></extra>'
            }];
            
            const layout = {
                title: 'Conformidade por Parâmetro (%)',
                height: 400,
                margin: {l: 50, r: 50, b: 50, t: 50, pad: 4},
                yaxis: {
                    range: [0, 100],
                    ticksuffix: '%'
                },
                showlegend: false
            };
            
            Plotly.newPlot('conformidadeParametro', data, layout, {responsive: true});
            Plotly.newPlot('conformidadeParametroTab', data, layout, {responsive: true});
        }
        
        // Função para criar gráfico de bairros com mais análises
        function criarGraficoBairrosAnalises(data) {
            // Ordenar por total de análises (decrescente)
            const bairrosOrdenados = [...data].sort((a, b) => b.total_analises - a.total_analises).slice(0, 20);
            
            const dadosGrafico = [{
                y: bairrosOrdenados.map(b => b.bairro),
                x: bairrosOrdenados.map(b => b.total_analises),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: '#0d6efd'
                },
                hovertemplate: '%{x}<extra></extra>'
            }];
            
            const layout = {
                title: 'Top 20 Bairros por Análises',
                height: 700, // Aumentado para dar mais espaço
                margin: {l: 200, r: 50, b: 50, t: 50, pad: 4},
                xaxis: {
                    title: 'Número de Análises'
                },
                showlegend: false
            };
            
            Plotly.newPlot('bairrosAnalises', dadosGrafico, layout, {responsive: true});
        }
        
        // Função para criar gráfico de bairros com menor conformidade
        function criarGraficoBairrosConformidade(data) {
            // Filtrar bairros com pelo menos 5 análises
            const bairrosFiltrados = data.filter(b => b.total_analises >= 5);
            
            // Ordenar por percentual de conformidade (crescente)
            const bairrosOrdenados = [...bairrosFiltrados].sort((a, b) => a.percentual_conforme - b.percentual_conforme).slice(0, 20);
            
            const dadosGrafico = [{
                y: bairrosOrdenados.map(b => b.bairro),
                x: bairrosOrdenados.map(b => b.percentual_conforme),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: '#dc3545'
                },
                hovertemplate: '%{x:.1f}%<extra></extra>'
            }];
            
            const layout = {
                title: 'Top 20 Bairros por Menor Conformidade (%)',
                height: 700, // Aumentado para dar mais espaço
                margin: {l: 200, r: 50, b: 50, t: 50, pad: 4},
                xaxis: {
                    title: 'Percentual de Conformidade',
                    ticksuffix: '%'
                },
                showlegend: false
            };
            
            Plotly.newPlot('bairrosConformidade', dadosGrafico, layout, {responsive: true});
        }
        
        // Função para criar gráfico de ponto de coleta
        function criarGraficoPontoColeta(data) {
            // Ordenar por percentual de conformidade (crescente)
            const pontosOrdenados = [...data].sort((a, b) => a.percentual_conforme - b.percentual_conforme).slice(0, 20);
            
            const dadosGrafico = [{
                y: pontosOrdenados.map(p => p.ponto_de_coleta),
                x: pontosOrdenados.map(p => p.percentual_conforme),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: '#0dcaf0'
                },
                hovertemplate: '%{x:.1f}%<extra></extra>'
            }];
            
            const layout = {
                title: 'Conformidade por Ponto de Coleta (%)',
                height: 700, // Aumentado para dar mais espaço
                margin: {l: 200, r: 50, b: 50, t: 50, pad: 4},
                xaxis: {
                    title: 'Percentual de Conformidade',
                    ticksuffix: '%'
                },
                showlegend: false
            };
            
            Plotly.newPlot('pontoColetaChart', dadosGrafico, layout, {responsive: true});
        }
        
        // Função para criar gráfico de distribuição por mês
        function criarGraficoDistribuicaoMes(data) {
            const dadosGrafico = [{
                x: data.map(m => m.nome_mes),
                y: data.map(m => m.total_amostras),
                type: 'bar',
                marker: {
                    color: '#6c757d'
                },
                hovertemplate: '%{y}<extra></extra>'
            }];
            
            const layout = {
                title: 'Distribuição de Amostras por Mês',
                height: 400,
                margin: {l: 50, r: 50, b: 50, t: 50, pad: 4},
                yaxis: {
                    title: 'Número de Amostras'
                },
                showlegend: false
            };
            
            Plotly.newPlot('distribuicaoMes', dadosGrafico, layout, {responsive: true});
        }
        
        // Função para criar gráfico de distribuição por parâmetro
        function criarGraficoDistribuicaoParametro() {
            const parametros = ['Escherichia coli', 'Coliformes totais', 'Turbidez', 'Cloro residual livre'];
            const quantidades = [50, 50, 50, 50, 29]; // Valores fictícios, ajustar conforme necessário
            
            const dadosGrafico = [{
                x: parametros,
                y: quantidades,
                type: 'bar',
                marker: {
                    color: '#6c757d'
                },
                hovertemplate: '%{y}<extra></extra>'
            }];
            
            const layout = {
                title: 'Distribuição de Amostras por Parâmetro',
                height: 400,
                margin: {l: 50, r: 50, b: 50, t: 50, pad: 4},
                yaxis: {
                    title: 'Número de Amostras'
                },
                showlegend: false
            };
            
            Plotly.newPlot('distribuicaoParametro', dadosGrafico, layout, {responsive: true});
        }
        
        // Função para criar gráfico de tendência de conformidade
        function criarGraficoTendenciaConformidade(data) {
            const dadosGrafico = [{
                x: data.map(m => m.nome_mes),
                y: data.map(m => m.percentual_conforme),
                type: 'scatter',
                mode: 'lines+markers',
                line: {
                    color: '#198754',
                    width: 3
                },
                marker: {
                    color: '#198754',
                    size: 8
                },
                hovertemplate: '%{y:.1f}%<extra></extra>'
            }];
            
            const layout = {
                title: 'Tendência de Conformidade ao Longo do Ano',
                height: 400,
                margin: {l: 50, r: 50, b: 50, t: 50, pad: 4},
                yaxis: {
                    title: 'Percentual de Conformidade',
                    range: [0, 100],
                    ticksuffix: '%'
                },
                showlegend: false
            };
            
            Plotly.newPlot('tendenciaConformidade', dadosGrafico, layout, {responsive: true});
        }
        
        // Função para criar gráfico de tendência por parâmetro
        function criarGraficoTendenciaParametro(data) {
            const traces = [];
            
            // Verificar se os dados de E. coli estão disponíveis
            if (data.length > 0 && data[0].percentual_ecoli !== undefined) {
                traces.push({
                    x: data.map(m => m.nome_mes),
                    y: data.map(m => m.percentual_ecoli),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'E. coli',
                    line: {width: 3},
                    hovertemplate: '%{y:.1f}%<extra>E. coli</extra>'
                });
            }
            
            // Verificar se os dados de Coliformes estão disponíveis
            if (data.length > 0 && data[0].percentual_coliformes !== undefined) {
                traces.push({
                    x: data.map(m => m.nome_mes),
                    y: data.map(m => m.percentual_coliformes),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Coliformes',
                    line: {width: 3},
                    hovertemplate: '%{y:.1f}%<extra>Coliformes</extra>'
                });
            }
            
            // Verificar se os dados de Turbidez estão disponíveis
            if (data.length > 0 && data[0].percentual_turbidez !== undefined) {
                traces.push({
                    x: data.map(m => m.nome_mes),
                    y: data.map(m => m.percentual_turbidez),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Turbidez',
                    line: {width: 3},
                    hovertemplate: '%{y:.1f}%<extra>Turbidez</extra>'
                });
            }
            
            // Verificar se os dados de Cloro estão disponíveis
            if (data.length > 0 && data[0].percentual_cloro !== undefined) {
                traces.push({
                    x: data.map(m => m.nome_mes),
                    y: data.map(m => m.percentual_cloro),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Cloro',
                    line: {width: 3},
                    hovertemplate: '%{y:.1f}%<extra>Cloro</extra>'
                });
            }
            
            const layout = {
                title: 'Tendência de Conformidade por Parâmetro',
                height: 400,
                margin: {l: 50, r: 50, b: 50, t: 50, pad: 4},
                yaxis: {
                    title: 'Percentual de Conformidade',
                    range: [0, 100],
                    ticksuffix: '%'
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.2
                }
            };
            
            Plotly.newPlot('tendenciaParametro', traces, layout, {responsive: true});
        }
        
        // Função para aplicar filtros
        function aplicarFiltros() {
            const filtros = {
                ano: $('#filtroAno').val(),
                mes: $('#filtroMes').val(),
                bairro: 'todos',
                parametro: 'todos'
            };
            
            // Mostrar indicador de carregamento
            $('body').append('<div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center;"><div style="background-color: white; padding: 20px; border-radius: 5px;"><i class="bi bi-arrow-repeat spin" style="font-size: 2rem; display: inline-block; animation: spin 1s linear infinite;"></i> <span style="margin-left: 10px;">Atualizando dados...</span></div></div>');
            $('<style>.spin { animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>').appendTo('head');
            
            $.ajax({
                url: '/api/filtrar_dados',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(filtros),
                success: function(data) {
                    // Atualizar estatísticas apenas na aba Visão Geral
                    atualizarEstatisticas(data);
                    
                    // Atualizar gráfico de conformidade por parâmetro
                    criarGraficoConformidadeParametro(
                        data.conformidade_ecoli,
                        data.conformidade_coliformes,
                        data.conformidade_turbidez,
                        data.conformidade_cloro
                    );
                    
                    // Remover indicador de carregamento
                    $('#loading-overlay').remove();
                },
                error: function(error) {
                    console.error('Erro ao aplicar filtros:', error);
                    alert('Erro ao aplicar filtros. Por favor, tente novamente.');
                    $('#loading-overlay').remove();
                }
            });
        }
        
        // Função para limpar filtros
        function limparFiltros() {
            $('#filtroAno').val('todos');
            $('#filtroMes').val('todos');
            $('#filtroBairro').val('todos');
            $('#filtroParametro').val('todos');
            
            aplicarFiltros();
        }
        
        // Função para atualizar estatísticas
        function atualizarEstatisticas(data) {
            // Atualizar valores na interface
            $('.stat-value:eq(0)').text(data.total_amostras);
            $('.stat-value:eq(1)').text(data.conformidade_geral.toFixed(1) + '%');
            $('.stat-value:eq(2)').text(data.nao_conformidade_geral.toFixed(1) + '%');
            $('.stat-value:eq(3)').text(data.bairros_unicos);
            
            // Atualizar gráficos
            criarGraficoDistribuicaoGeral(data.conformidade_geral, data.nao_conformidade_geral);
            criarGraficoConformidadeParametro(
                data.conformidade_ecoli,
                data.conformidade_coliformes,
                data.conformidade_turbidez,
                data.conformidade_cloro
            );
            
            // Atualizar tabela de resumo
            $('tbody tr:eq(0) td:eq(2)').text(data.conformidade_ecoli.toFixed(1) + '%');
            $('tbody tr:eq(1) td:eq(2)').text(data.conformidade_coliformes.toFixed(1) + '%');
            $('tbody tr:eq(2) td:eq(2)').text(data.conformidade_turbidez.toFixed(1) + '%');
            $('tbody tr:eq(3) td:eq(2)').text(data.conformidade_cloro.toFixed(1) + '%');
            
            // Atualizar badges de status
            $('tbody tr:eq(0) td:eq(3) span').attr('class', data.conformidade_ecoli >= 90 ? 'badge bg-success' : data.conformidade_ecoli >= 70 ? 'badge bg-warning text-dark' : 'badge bg-danger');
            $('tbody tr:eq(0) td:eq(3) span').text(data.conformidade_ecoli >= 90 ? 'Excelente' : data.conformidade_ecoli >= 70 ? 'Atenção' : 'Crítico');
            
            $('tbody tr:eq(1) td:eq(3) span').attr('class', data.conformidade_coliformes >= 90 ? 'badge bg-success' : data.conformidade_coliformes >= 70 ? 'badge bg-warning text-dark' : 'badge bg-danger');
            $('tbody tr:eq(1) td:eq(3) span').text(data.conformidade_coliformes >= 90 ? 'Excelente' : data.conformidade_coliformes >= 70 ? 'Atenção' : 'Crítico');
            
            $('tbody tr:eq(2) td:eq(3) span').attr('class', data.conformidade_turbidez >= 90 ? 'badge bg-success' : data.conformidade_turbidez >= 70 ? 'badge bg-warning text-dark' : 'badge bg-danger');
            $('tbody tr:eq(2) td:eq(3) span').text(data.conformidade_turbidez >= 90 ? 'Excelente' : data.conformidade_turbidez >= 70 ? 'Atenção' : 'Crítico');
            
            $('tbody tr:eq(3) td:eq(3) span').attr('class', data.conformidade_cloro >= 90 ? 'badge bg-success' : data.conformidade_cloro >= 70 ? 'badge bg-warning text-dark' : 'badge bg-danger');
            $('tbody tr:eq(3) td:eq(3) span').text(data.conformidade_cloro >= 90 ? 'Excelente' : data.conformidade_cloro >= 70 ? 'Atenção' : 'Crítico');
        }
        
        // Função para atualizar dados
        function atualizarDados() {
            $.ajax({
                url: '/atualizar_dados',
                type: 'POST',
                success: function(response) {
                    if (response.status === 'success') {
                        alert('Dados atualizados com sucesso!');
                        location.reload();
                    } else {
                        alert('Erro ao atualizar dados: ' + response.message);
                    }
                },
                error: function(error) {
                    console.error('Erro ao atualizar dados:', error);
                    alert('Erro ao atualizar dados. Por favor, tente novamente.');
                }
            });
        }
        
        // Inicialização
        $(document).ready(function() {
            // Criar gráficos iniciais
            criarGraficoDistribuicaoGeral({{ stats.conformidade_geral }}, {{ stats.nao_conformidade_geral }});
            criarGraficoConformidadeParametro(
                {{ stats.conformidade_ecoli }},
                {{ stats.conformidade_coliformes }},
                {{ stats.conformidade_turbidez }},
                {{ stats.conformidade_cloro }}
            );
            criarGraficoDistribuicaoParametro();
            
            // Carregar dados
            carregarDadosBairros();
            carregarDistribuicaoMes();
            carregarDistribuicaoPontoColeta();
            
            // Event listeners
            $('#btnAplicarFiltros').click(aplicarFiltros);
            $('#btnLimparFiltros').click(limparFiltros);
            $('#btnAtualizar').click(atualizarDados);
            
            // Ajustar altura da sidebar
            function ajustarAlturaSidebar() {
                const windowHeight = $(window).height();
                const navbarHeight = $('.navbar').outerHeight();
                $('.sidebar').css('height', windowHeight - navbarHeight);
                $('.sidebar').css('top', navbarHeight);
            }
            
            ajustarAlturaSidebar();
            $(window).resize(ajustarAlturaSidebar);
        });
    </script>
</body>
</html>
